<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Tranquil Anchor</title>
<style>
  :root{
    --bg:#f5f7fa;
    --card:#ffffff;
    --muted:#6b7280;
    --accent:#059669;
    --accent-2:#10b981;
    --warm:#f59e0b;
    --cool:#3b82f6;
    --shadow: 0 4px 12px rgba(0,0,0,0.08);
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#e5e7eb);color:#1f2937}
  .wrap{max-width:1100px;margin:20px auto;padding:20px;display:grid;gap:16px;grid-template-columns:1fr 340px;}
  @media (max-width:900px){.wrap{grid-template-columns:1fr; padding:12px}}
  header{display:flex;align-items:center;gap:14px;margin-bottom:8px}
  .logo{width:56px;height:56px;border-radius:14px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;color:white;font-weight:700;box-shadow:var(--shadow);font-size:22px}
  h1{margin:0;font-size:24px;color:#111827}
  p.lead{margin:6px 0 0;color:var(--muted);font-size:14px;line-height:1.5}
  .card{background:var(--card);border-radius:14px;padding:20px;box-shadow:var(--shadow);}
  .big{padding:32px}
  h2{margin:0 0 10px;font-size:18px;color:#111827}
  .tiny{font-size:13px;color:var(--muted);line-height:1.4}
  
  /* Physiological sigh breathing */
  .breathArea{text-align:center;padding:20px 0}
  .circle{width:220px;height:220px;border-radius:50%;margin:16px auto;display:flex;align-items:center;justify-content:center;background:radial-gradient(circle at 40% 30%, rgba(5,150,105,0.15), rgba(5,150,105,0.05));transition:transform 1.2s cubic-bezier(0.4,0,0.2,1);box-shadow:0 8px 24px rgba(5,150,105,0.12);position:relative}
  .circle::before{content:'';position:absolute;inset:-8px;border-radius:50%;border:2px solid rgba(5,150,105,0.15);opacity:0;transition:opacity 0.3s}
  .circle.active::before{opacity:1;animation:pulse 2s infinite}
  @keyframes pulse{0%,100%{transform:scale(1);opacity:0.3}50%{transform:scale(1.05);opacity:0.6}}
  .circle-label{font-size:24px;color:var(--accent);font-weight:600}
  
  /* Cognitive reappraisal */
  .thought-card{background:#fefce8;border-left:4px solid var(--warm);padding:16px;border-radius:8px;margin:12px 0}
  .reframe-card{background:#eff6ff;border-left:4px solid var(--cool);padding:16px;border-radius:8px;margin:12px 0;cursor:pointer;transition:all 0.2s}
  .reframe-card:hover{background:#dbeafe;transform:translateX(4px)}
  textarea{width:100%;padding:12px;border-radius:10px;border:1px solid #e5e7eb;font-size:14px;font-family:inherit;resize:vertical;min-height:80px}
  
  /* Progressive muscle relaxation */
  .muscle-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:10px;margin:16px 0}
  .muscle-btn{padding:16px 12px;border:2px solid #e5e7eb;background:white;border-radius:10px;cursor:pointer;transition:all 0.3s;font-size:13px;font-weight:500}
  .muscle-btn:hover{border-color:var(--accent);background:#f0fdf4}
  .muscle-btn.active{background:var(--accent);color:white;border-color:var(--accent)}
  
  /* Attention redirect - gratitude */
  .gratitude-list{list-style:none;padding:0;margin:16px 0}
  .gratitude-item{padding:14px;background:#f9fafb;border-radius:8px;margin:8px 0;display:flex;justify-content:space-between;align-items:center}
  .gratitude-item button{background:transparent;border:none;color:var(--muted);cursor:pointer;padding:4px 8px;font-size:18px}
  
  /* Anger thermometer */
  .thermometer{height:240px;width:48px;background:linear-gradient(to bottom,#ef4444 0%,#f59e0b 50%,#10b981 100%);border-radius:24px;position:relative;margin:20px auto}
  .therm-marker{position:absolute;left:50%;transform:translateX(-50%);width:64px;height:4px;background:#1f2937;transition:bottom 0.3s;box-shadow:0 2px 8px rgba(0,0,0,0.3)}
  .therm-labels{display:flex;flex-direction:column-reverse;justify-content:space-between;height:240px;position:absolute;left:60px;top:0;font-size:12px;color:var(--muted)}
  
  button,select{border:0;background:var(--accent);color:white;padding:12px 16px;border-radius:10px;cursor:pointer;font-weight:600;font-size:14px;transition:all 0.2s}
  button:hover{background:var(--accent-2);transform:translateY(-1px)}
  button:disabled{opacity:0.5;cursor:not-allowed;transform:none}
  button.secondary{background:white;color:var(--accent);border:2px solid var(--accent)}
  button.secondary:hover{background:#f0fdf4}
  .small{font-size:13px;padding:10px 14px}
  
  label{display:block;margin-bottom:8px;color:#374151;font-size:14px;font-weight:500}
  input[type=text],input[type=number],input[type=date]{padding:10px 12px;border-radius:8px;border:1px solid #e5e7eb;font-size:14px;font-family:inherit}
  
  .pill{background:#f0fdf4;padding:8px 14px;border-radius:999px;color:var(--accent);font-weight:600;font-size:13px;display:inline-block}
  .pill.warning{background:#fef3c7;color:#92400e}
  .pill.danger{background:#fee2e2;color:#991b1b}
  
  .progress-ring{transform:rotate(-90deg);width:120px;height:120px}
  .progress-ring-circle{fill:none;stroke:#e5e7eb;stroke-width:8}
  .progress-ring-circle.filled{stroke:var(--accent);transition:stroke-dashoffset 0.3s}
  
  .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:14px}
  .evidence-badge{background:#eff6ff;border:1px solid #bfdbfe;padding:8px 12px;border-radius:8px;font-size:12px;color:#1e40af;margin:8px 0}
  
  ul.tips{line-height:1.6;color:var(--muted);font-size:14px}
  ul.tips li{margin:8px 0}
  
  /* Dashboard */
  .dashboard{display:none}
  .dashboard.active{display:block}
  .main-view{display:block}
  .main-view.hidden{display:none}
  .history-entry{background:#f9fafb;padding:16px;border-radius:10px;margin:12px 0;border-left:4px solid var(--accent)}
  .history-entry h4{margin:0 0 8px;color:#111827}
  .history-entry .meta{font-size:12px;color:var(--muted);margin-bottom:8px}
  .history-entry .notes{font-size:13px;color:#374151;margin-top:8px}
  .tab-buttons{display:flex;gap:8px;margin-bottom:16px}
  .tab-btn{background:#f3f4f6;color:#4b5563;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:600}
  .tab-btn.active{background:var(--accent);color:white}
  .stat-card{background:#f0fdf4;padding:16px;border-radius:10px;text-align:center;margin:8px 0}
  .stat-number{font-size:32px;font-weight:700;color:var(--accent)}
  .stat-label{font-size:13px;color:var(--muted);margin-top:4px}
  .chart-bar{background:#e5e7eb;height:24px;border-radius:4px;position:relative;margin:8px 0}
  .chart-fill{background:var(--accent);height:100%;border-radius:4px;transition:width 0.3s}
</style>
</head>
<body>
<main class="wrap" role="main">
  <section class="main-view" id="mainView">
    <header>
      <div class="logo" aria-hidden="true">TA</div>
      <div style="flex:1">
        <h1>Tranquil Anchor</h1>
        <p class="lead">Evidence-based emotion regulation toolkit combining physiological calming, cognitive reappraisal, and attention redirection.</p>
      </div>
      <button id="dashboardBtn" class="small secondary">Dashboard</button>
    </header>

    <div class="card big" aria-labelledby="sighTitle">
      <h2 id="sighTitle">Physiological Sigh (Immediate Relief)</h2>
      <div class="evidence-badge">Stanford/Huberman Lab research: Most effective breathing pattern for rapid stress reduction</div>
      <p class="tiny">Double inhale through nose, long exhale through mouth. Proven to rapidly reduce physiological arousal and cortisol levels.</p>

      <div class="breathArea">
        <div id="sighCircle" class="circle" aria-live="polite">
          <div class="circle-label" id="sighLabel">Ready</div>
        </div>

        <div class="controls">
          <button id="startSigh" class="small">Start Physiological Sigh</button>
          <button id="stopSigh" class="small secondary" disabled>Stop</button>
          <div style="margin-left:12px">
            <label class="tiny" style="display:inline;margin-right:8px">Cycles:</label>
            <input id="sighCycles" type="number" min="3" max="15" value="5" style="width:60px" />
          </div>
        </div>

        <div style="margin-top:20px;text-align:center">
          <div class="tiny">Completed: <strong id="sighCount">0</strong> cycles today</div>
        </div>
      </div>
    </div>

    <div class="card" aria-labelledby="reappraisalTitle">
      <h2 id="reappraisalTitle">Cognitive Reappraisal</h2>
      <div class="evidence-badge">James Gross (Stanford): Most effective emotion regulation strategy long-term</div>
      <p class="tiny">Reframe the anger-triggering situation. Research shows cognitive reappraisal reduces amygdala activation.</p>

      <label>What triggered the anger? (Be specific)</label>
      <textarea id="triggerThought" placeholder="Example: My coworker dismissed my idea in the meeting without even listening to it..."></textarea>

      <button id="generateReframe" style="margin:12px 0">Generate AI Reframe Prompts</button>

      <div id="reframePrompts" style="margin-top:16px"></div>

      <div style="margin-top:16px">
        <label>Your reframed perspective:</label>
        <textarea id="reframedThought" placeholder="Write your alternative interpretation here..."></textarea>
        <button id="saveReframe" class="small" style="margin-top:8px">Save Reframe</button>
      </div>
    </div>

    <div class="card" aria-labelledby="pmrTitle">
      <h2 id="pmrTitle">Progressive Muscle Relaxation</h2>
      <div class="evidence-badge">Jacobson's PMR: Clinically proven to reduce physiological tension and anger</div>
      <p class="tiny">Tense each muscle group for 5 seconds, then release for 10 seconds. This breaks the anger-tension cycle.</p>

      <div class="muscle-grid" id="muscleGrid">
        <button class="muscle-btn" data-muscle="jaw">Jaw & Face</button>
        <button class="muscle-btn" data-muscle="neck">Neck</button>
        <button class="muscle-btn" data-muscle="shoulders">Shoulders</button>
        <button class="muscle-btn" data-muscle="arms">Arms</button>
        <button class="muscle-btn" data-muscle="hands">Hands/Fists</button>
        <button class="muscle-btn" data-muscle="chest">Chest</button>
        <button class="muscle-btn" data-muscle="stomach">Stomach</button>
        <button class="muscle-btn" data-muscle="legs">Legs</button>
      </div>

      <div style="text-align:center;margin-top:16px">
        <button id="startPMR" class="small">Start Guided PMR Sequence</button>
        <button id="stopPMR" class="small secondary" style="margin-left:8px">Stop</button>
        <div class="tiny" style="margin-top:12px" id="pmrInstruction">Click a muscle group or start full sequence</div>
      </div>
    </div>

    <div class="card" aria-labelledby="gratitudeTitle">
      <h2 id="gratitudeTitle">Attention Redirection: Gratitude Practice</h2>
      <div class="evidence-badge">Emmons & McCullough: Gratitude practice reduces negative emotions by 35%</div>
      <p class="tiny">List things you're grateful for RIGHT NOW. This shifts attention away from anger triggers.</p>

      <label>Add something you're grateful for today:</label>
      <div style="display:flex;gap:8px">
        <input type="text" id="gratitudeInput" placeholder="Example: Morning coffee, a friend's text, sunshine..." style="flex:1" />
        <button id="addGratitude" class="small">Add</button>
      </div>

      <div class="gratitude-list" id="gratitudeList"></div>
    </div>

    <div class="card" aria-labelledby="tipsTitle">
      <h2 id="tipsTitle">Usage Protocol</h2>
      <ul class="tips">
        <li><strong>Immediate anger (0-2 minutes):</strong> Start with 3-5 Physiological Sighs immediately. This is the fastest way to calm the nervous system.</li>
        <li><strong>After initial calm (2-10 minutes):</strong> Use Cognitive Reappraisal to reframe the situation. Write out the trigger and alternative perspectives.</li>
        <li><strong>Lingering tension (10-20 minutes):</strong> Do Progressive Muscle Relaxation to release physical anger manifestations.</li>
        <li><strong>Shift attention completely (ongoing):</strong> Add 3 gratitude items to redirect mental focus to positive stimuli.</li>
      </ul>
    </div>
  </section>

  <section class="dashboard" id="dashboardView">
    <header style="margin-bottom:20px">
      <div style="display:flex;align-items:center;justify-content:space-between">
        <div>
          <h1>History Dashboard</h1>
          <p class="lead">Track your anger levels and intervention effectiveness over time</p>
        </div>
        <button id="backBtn" class="small secondary">Back</button>
      </div>
    </header>

    <div class="card">
      <div class="tab-buttons">
        <button class="tab-btn active" data-tab="overview">Overview</button>
        <button class="tab-btn" data-tab="history">History Log</button>
        <button class="tab-btn" data-tab="stats">Statistics</button>
      </div>

      <div id="overviewTab" class="tab-content">
        <h2>Today's Summary</h2>
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:12px;margin:16px 0">
          <div class="stat-card">
            <div class="stat-number" id="avgAngerToday">0</div>
            <div class="stat-label">Avg Anger Level</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="entriesCountToday">0</div>
            <div class="stat-label">Entries Today</div>
          </div>
          <div class="stat-card">
            <div class="stat-number" id="sighsToday">0</div>
            <div class="stat-label">Breathing Sessions</div>
          </div>
        </div>

        <h3 style="margin-top:24px">Recent Entries (Last 5)</h3>
        <div id="recentEntries"></div>
      </div>

      <div id="historyTab" class="tab-content" style="display:none">
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:16px">
          <label class="tiny" style="margin:0">Filter by date:</label>
          <input type="date" id="filterDate" />
          <button id="clearFilter" class="small secondary">Show All</button>
        </div>
        <div id="historyLog"></div>
      </div>

      <div id="statsTab" class="tab-content" style="display:none">
        <h2>Technique Effectiveness</h2>
        <p class="tiny">Average anger reduction after each technique</p>
        
        <div style="margin:20px 0">
          <div style="margin-bottom:8px">
            <div class="tiny" style="margin-bottom:4px">Physiological Sigh</div>
            <div class="chart-bar">
              <div class="chart-fill" id="breathEffect" style="width:0%"></div>
            </div>
          </div>
          <div style="margin-bottom:8px">
            <div class="tiny" style="margin-bottom:4px">Cognitive Reappraisal</div>
            <div class="chart-bar">
              <div class="chart-fill" id="reappraisalEffect" style="width:0%"></div>
            </div>
          </div>
          <div style="margin-bottom:8px">
            <div class="tiny" style="margin-bottom:4px">PMR</div>
            <div class="chart-bar">
              <div class="chart-fill" id="pmrEffect" style="width:0%"></div>
            </div>
          </div>
          <div style="margin-bottom:8px">
            <div class="tiny" style="margin-bottom:4px">Gratitude</div>
            <div class="chart-bar">
              <div class="chart-fill" id="gratitudeEffect" style="width:0%"></div>
            </div>
          </div>
        </div>

        <h3 style="margin-top:24px">7-Day Trend</h3>
        <div id="weeklyTrend"></div>
      </div>
    </div>
  </section>

  <aside>
    <div class="card" aria-labelledby="thermTitle">
      <h2 id="thermTitle">Anger Intensity Tracker</h2>
      <p class="tiny">Rate your current anger level (0-10):</p>
      
      <div style="position:relative;height:260px;margin:20px 0">
        <div class="thermometer">
          <div class="therm-marker" id="thermMarker" style="bottom:0px"></div>
        </div>
        <div class="therm-labels">
          <span>0 - Peace</span>
          <span>2</span>
          <span>4 - Calm</span>
          <span>6</span>
          <span>8 - Angry</span>
          <span>10 - Rage</span>
        </div>
      </div>

      <input type="range" id="angerLevel" min="0" max="10" value="5" style="width:100%" />
      <div style="text-align:center;margin:12px 0">
        <div class="pill" id="angerPill">Level: 5</div>
      </div>

      <label class="tiny">Optional notes about this moment:</label>
      <textarea id="angerNotes" style="min-height:60px;font-size:13px" placeholder="What happened? What are you feeling?"></textarea>

      <button id="logAnger" class="small" style="width:100%;margin-top:8px">Log Current Level & Notes</button>

      <div style="margin-top:16px;font-size:12px;color:var(--muted);padding:12px;background:#f9fafb;border-radius:8px">
        <strong>Last 3 readings:</strong>
        <div id="angerHistory" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="card" style="margin-top:16px" aria-labelledby="progressTitle">
      <h2 id="progressTitle">Today's Progress</h2>
      
      <div style="text-align:center;margin:20px 0 30px 0">
        <svg class="progress-ring">
          <circle class="progress-ring-circle" cx="60" cy="60" r="52" stroke-width="8"></circle>
          <circle class="progress-ring-circle filled" id="progressCircle" cx="60" cy="60" r="52" stroke-width="8" stroke-dasharray="326.73" stroke-dashoffset="326.73"></circle>
        </svg>
        <div style="margin-top:-75px">
          <div style="font-size:32px;font-weight:700;color:var(--accent);margin-bottom:4px" id="techniqueCount">0/4</div>
          <div class="tiny"></div>
        </div>
      </div>

      <div style="margin-top:20px">
        <div class="pill" id="breathPill" style="margin:4px;opacity:0.3">Breathing</div>
        <div class="pill" id="reappraisalPill" style="margin:4px;opacity:0.3">Reappraisal</div>
        <div class="pill" id="pmrPill" style="margin:4px;opacity:0.3">PMR</div>
        <div class="pill" id="gratitudePill" style="margin:4px;opacity:0.3">Gratitude</div>
      </div>
    </div>

    <div class="card" style="margin-top:16px" aria-labelledby="scienceTitle">
      <h2 id="scienceTitle">Scientific Basis</h2>
      <p class="tiny" style="line-height:1.5">
        <strong>Physiological Sigh:</strong> Huberman Lab, 2023<br>
        <strong>Cognitive Reappraisal:</strong> Gross & John, 2003<br>
        <strong>PMR:</strong> Jacobson, 1938; McCallie et al., 2006<br>
        <strong>Gratitude:</strong> Emmons & McCullough, 2003
      </p>
    </div>
  </aside>
</main>

<script>
const $ = id => document.getElementById(id);

// State management
let state = {
  currentAngerLevel: 5,
  sighRunning: false,
  pmrRunning: false,
  entries: JSON.parse(localStorage.getItem('angerEntries') || '[]'),
  techniquesUsed: JSON.parse(localStorage.getItem('techniquesUsed') || '{}')
};

/* ===== PHYSIOLOGICAL SIGH ===== */
let sighTimer = null;

function startSigh() {
  if (state.sighRunning) return;
  state.sighRunning = true;
  $('startSigh').disabled = true;
  $('stopSigh').disabled = false;
  
  const cycles = parseInt($('sighCycles').value) || 5;
  const startAnger = state.currentAngerLevel;
  let currentCycle = 0;
  
  const circle = $('sighCircle');
  const label = $('sighLabel');
  
  function runCycle() {
    if (!state.sighRunning || currentCycle >= cycles) {
      // Breathing complete
      const endAnger = state.currentAngerLevel;
      const reduction = Math.max(0, startAnger - endAnger);
      
      addEntry({
        type: 'breathing',
        technique: 'Physiological Sigh',
        startAnger,
        endAnger,
        reduction,
        cycles,
        notes: `Completed ${cycles} physiological sigh cycles`
      });
      
      stopSigh();
      markTechniqueUsed('breath');
      
      // Update count
      const count = parseInt(localStorage.getItem('sighCount') || '0') + 1;
      localStorage.setItem('sighCount', count);
      $('sighCount').textContent = count;
      
      return;
    }
    
    // First inhale
    label.textContent = 'Inhale deeply (nose)';
    circle.style.transform = 'scale(1.15)';
    circle.classList.add('active');
    
    setTimeout(() => {
      if (!state.sighRunning) return;
      label.textContent = 'Sip more air!';
      circle.style.transform = 'scale(1.25)';
    }, 2000);
    
    setTimeout(() => {
      if (!state.sighRunning) return;
      label.textContent = 'Exhale slowly (mouth)';
      circle.style.transform = 'scale(0.85)';
    }, 3000);
    
    setTimeout(() => {
      if (!state.sighRunning) return;
      currentCycle++;
      label.textContent = `Rest (${currentCycle}/${cycles})`;
      circle.style.transform = 'scale(1)';
      
      setTimeout(() => {
        if (state.sighRunning) runCycle();
      }, 2000);
    }, 8000);
  }
  
  runCycle();
}

function stopSigh() {
  state.sighRunning = false;
  $('startSigh').disabled = false;
  $('stopSigh').disabled = true;
  $('sighLabel').textContent = 'Complete';
  $('sighCircle').style.transform = 'scale(1)';
  $('sighCircle').classList.remove('active');
  clearTimeout(sighTimer);
  
  setTimeout(() => {
    $('sighLabel').textContent = 'Ready';
  }, 2000);
}

$('startSigh').addEventListener('click', startSigh);
$('stopSigh').addEventListener('click', stopSigh);

/* ===== COGNITIVE REAPPRAISAL WITH AI PROMPTS ===== */
async function generateAIReframePrompts(trigger) {
  try {
    const response = await fetch("https://api.anthropic.com/v1/messages", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        model: "claude-sonnet-4-20250514",
        max_tokens: 2000,
        system: "You are an expert cognitive behavioral therapist specializing in anger management and emotion regulation. Generate exactly 4 personalized cognitive reappraisal questions based on the user's specific anger trigger. Respond ONLY with valid JSON - an array of 4 strings. No markdown, no explanation, just the JSON array.",
        messages: [
          {
            role: "user",
            content: `Generate 4 highly specific cognitive reappraisal questions for this anger trigger. These questions should challenge their interpretation, introduce alternative perspectives, and use CBT techniques. Make them directly relevant to this specific situation, not generic.

Anger trigger: "${trigger}"

Respond with ONLY a JSON array of 4 questions, nothing else. Example format:
["Question 1?", "Question 2?", "Question 3?", "Question 4?"]`
          }
        ]
      })
    });

    if (!response.ok) {
      throw new Error(`API error: ${response.status}`);
    }

    const data = await response.json();
    console.log('API Response:', data);
    
    if (data.content && data.content.length > 0) {
      let text = '';
      
      // Combine all text blocks
      for (const block of data.content) {
        if (block.type === 'text') {
          text += block.text;
        }
      }
      
      console.log('Extracted text:', text);
      
      // Clean up the text - remove markdown fences and extra whitespace
      text = text.trim()
        .replace(/```json\s*/g, '')
        .replace(/```\s*/g, '')
        .replace(/^\s*\n/gm, '');
      
      console.log('Cleaned text:', text);
      
      // Try to parse the JSON
      const prompts = JSON.parse(text);
      
      if (Array.isArray(prompts) && prompts.length > 0) {
        return {
          success: true,
          prompts: prompts.slice(0, 4)
        };
      }
    }
    
    throw new Error('Invalid response format');
    
  } catch (error) {
    console.error('Full error details:', error);
    console.error('Error message:', error.message);
    
    // Fallback to intelligent template-based system
    return generateIntelligentFallback(trigger);
  }
}

// Intelligent fallback system that analyzes context deeply
function generateIntelligentFallback(trigger) {
  const lower = trigger.toLowerCase();
  const words = lower.split(/\s+/);
  
  // Advanced contextual analysis
  const context = {
    interpersonal: /\b(said|told|they|he|she|person|people|friend|family|coworker|colleague|partner|spouse|boss|manager|teacher)\b/.test(lower),
    work: /\b(work|job|boss|project|meeting|deadline|presentation|report|office|client|task|performance|review)\b/.test(lower),
    injustice: /\b(unfair|deserve|should|shouldn't|not fair|justice|wrong|right|shouldn't have)\b/.test(lower),
    frustration: /\b(can't|cannot|won't|wouldn't|stuck|prevent|stop|block|impossible|unable|tried)\b/.test(lower),
    boundaries: /\b(disrespect|rude|insult|boundary|violate|ignore|dismiss|interrupt|cross|invade)\b/.test(lower),
    criticism: /\b(criticize|criticized|judged|blamed|fault|attacked|accused|wrong|mistake)\b/.test(lower),
    rejection: /\b(reject|ignored|dismissed|excluded|left out|didn't invite|forgot|overlook)\b/.test(lower),
    control: /\b(control|force|make me|told me|demand|order|insist|pressure)\b/.test(lower)
  };
  
  // Extract key entities and actions
  const hasNegation = /\b(didn't|don't|doesn't|won't|wouldn't|never|no|not)\b/.test(lower);
  const hasPast = /\b(was|were|did|had|got|made|said|told|went)\b/.test(lower);
  const hasEmotionWords = /\b(angry|mad|furious|upset|frustrated|annoyed|irritated|hurt|feel|felt)\b/.test(lower);
  
  let prompts = [];
  
  // Generate prompts based on deep context analysis
  if (context.interpersonal && context.criticism) {
    prompts = [
      `What if this person's critical comment reveals more about their own stress, insecurity, or communication style than about your actual worth or competence?`,
      `If you imagine watching this interaction as a neutral observer who cares about both people, what might you notice about the underlying needs or fears on both sides?`,
      `How would your response change if you assumed this person is doing the best they can with their current emotional resources and communication skills?`,
      `In what ways might their criticism contain even a small grain of useful information, separate from the hurtful delivery method?`
    ];
  } else if (context.work && context.injustice) {
    prompts = [
      `What organizational or systemic factors might be driving this decision that have nothing to do with your personal value?`,
      `If you separate your professional identity from your self-worth, how does this situation look different?`,
      `What would it mean to advocate for fairness in this situation while simultaneously accepting that you can't control the outcome?`,
      `Looking at this from a 5-year perspective: what will matter more - being right about this, or how you chose to respond?`
    ];
  } else if (context.boundaries && (context.disrespect || context.rejection)) {
    prompts = [
      `Is your anger providing useful information that a boundary needs to be communicated or reinforced? What specific boundary is that?`,
      `What would a response look like that honors your self-respect without requiring the other person to change or apologize?`,
      `If you viewed this as data about compatibility or relationship dynamics rather than a personal attack, what would you do differently?`,
      `How can you validate your own feelings and needs here, independent of whether this person recognizes or meets them?`
    ];
  } else if (context.frustration && context.control) {
    prompts = [
      `What aspects of this situation are genuinely within your control versus outside your control? Where is your energy best directed?`,
      `If this obstacle is actually redirecting you toward a better path you haven't seen yet, what might that path be?`,
      `What would it mean to fully accept this limitation while simultaneously staying open to creative solutions?`,
      `How would you advise someone you deeply respect if they were facing this exact frustration?`
    ];
  } else if (hasNegation && hasPast) {
    // Something didn't happen that should have
    prompts = [
      `What unexpressed expectations or assumptions might you have been holding that didn't get communicated clearly?`,
      `If you viewed this as a mismatch of priorities or awareness rather than intentional disregard, how would that change things?`,
      `What's one small thing you can do right now to address the underlying need that isn't being met?`,
      `How might this disappointment actually be protecting you from something or pointing you toward what really matters?`
    ];
  } else {
    // Deep general reframing for any situation
    prompts = [
      `If you step back from the immediate emotional reaction, what is the core need or value of yours that feels threatened here?`,
      `What are three radically different explanations for why this happened that don't assume malicious intent toward you?`,
      `How would the wisest version of yourself - the one who's already moved past this - interpret this situation?`,
      `If anger is energy, what constructive action could you channel this energy toward that serves your actual goals?`
    ];
  }
  
  return {
    success: true,
    prompts: prompts,
    fallback: true
  };
}

$('generateReframe').addEventListener('click', async () => {
  const trigger = $('triggerThought').value.trim();
  if (!trigger || trigger.length < 10) {
    alert('Please describe what triggered your anger in more detail (at least 10 characters).');
    return;
  }
  
  const promptsDiv = $('reframePrompts');
  const btn = $('generateReframe');
  
  // Show loading state
  btn.disabled = true;
  btn.textContent = 'Generating personalized prompts...';
  promptsDiv.innerHTML = '<div class="thought-card"><strong>Your anger trigger:</strong><br>' + trigger + '</div><p class="tiny" style="color:var(--accent);margin:12px 0">Analyzing your situation and generating personalized reframing questions...</p>';
  
  const result = await generateAIReframePrompts(trigger);
  
  btn.disabled = false;
  btn.textContent = 'Generate AI Reframe Prompts';
  
  if (!result.success) {
    promptsDiv.innerHTML += `<div style="padding:12px;background:#fee2e2;border-radius:8px;color:#991b1b;margin:12px 0">Unable to generate prompts. Please try again or check your connection.</div>`;
    return;
  }
  
  promptsDiv.innerHTML = '<div class="thought-card"><strong>Your anger trigger:</strong><br>' + trigger + '</div>';
  promptsDiv.innerHTML += `<p class="tiny" style="color:var(--accent);font-weight:600;margin:8px 0">${result.fallback ? 'Context-analyzed' : 'AI-generated'} personalized reframing questions for your specific situation:</p>`;
  
  result.prompts.forEach((prompt, i) => {
    const escapedPrompt = prompt.replace(/'/g, "\\'").replace(/"/g, '&quot;');
    promptsDiv.innerHTML += `<div class="reframe-card" onclick="document.getElementById('reframedThought').value += '\\n\\nQ${i+1}: ${escapedPrompt}\\n\\nA: '">
      <strong>Question ${i+1}:</strong><br>${prompt}
      <div style="font-size:11px;margin-top:8px;color:var(--muted)">Click to add to your response</div>
    </div>`;
  });
});

$('saveReframe').addEventListener('click', () => {
  const trigger = $('triggerThought').value.trim();
  const reframe = $('reframedThought').value.trim();
  
  if (!trigger || !reframe) {
    alert('Please complete both the trigger and your reframed perspective.');
    return;
  }
  
  const startAnger = state.currentAngerLevel;
  
  addEntry({
    type: 'reappraisal',
    technique: 'Cognitive Reappraisal',
    startAnger,
    trigger,
    reframe,
    notes: `Reframed: "${trigger.substring(0, 50)}..."`
  });
  
  markTechniqueUsed('reappraisal');
  
  alert('Reframe saved! Take a moment to notice how your emotional state shifted.');
  $('triggerThought').value = '';
  $('reframedThought').value = '';
  $('reframePrompts').innerHTML = '';
});

/* ===== PROGRESSIVE MUSCLE RELAXATION ===== */
let pmrTimer = null;
const muscles = ['jaw', 'neck', 'shoulders', 'arms', 'hands', 'chest', 'stomach', 'legs'];
let currentMuscleIndex = 0;

document.querySelectorAll('.muscle-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    const muscle = e.target.dataset.muscle;
    if (state.pmrRunning) return;
    
    e.target.classList.add('active');
    $('pmrInstruction').textContent = `Tense your ${muscle} tightly for 5 seconds...`;
    
    setTimeout(() => {
      $('pmrInstruction').textContent = `Release your ${muscle} completely. Feel the relaxation for 10 seconds...`;
    }, 5000);
    
    setTimeout(() => {
      e.target.classList.remove('active');
      $('pmrInstruction').textContent = 'Complete! Notice the difference between tension and relaxation.';
    }, 15000);
  });
});

$('startPMR').addEventListener('click', () => {
  if (state.pmrRunning) return;
  state.pmrRunning = true;
  currentMuscleIndex = 0;
  $('startPMR').disabled = true;
  
  const startAnger = state.currentAngerLevel;
  
  function runMuscle() {
    if (currentMuscleIndex >= muscles.length) {
      state.pmrRunning = false;
      $('startPMR').disabled = false;
      $('pmrInstruction').textContent = 'Full sequence complete! Your body should feel noticeably more relaxed.';
      document.querySelectorAll('.muscle-btn').forEach(b => b.classList.remove('active'));
      
      const endAnger = state.currentAngerLevel;
      addEntry({
        type: 'pmr',
        technique: 'Progressive Muscle Relaxation',
        startAnger,
        endAnger,
        reduction: Math.max(0, startAnger - endAnger),
        notes: 'Completed full 8-muscle PMR sequence'
      });
      
      markTechniqueUsed('pmr');
      return;
    }
    
    const muscle = muscles[currentMuscleIndex];
    const btn = document.querySelector(`[data-muscle="${muscle}"]`);
    btn.classList.add('active');
    
    $('pmrInstruction').textContent = `Tense your ${muscle} tightly - hold for 5 seconds`;
    
    setTimeout(() => {
      $('pmrInstruction').textContent = `Release your ${muscle} completely - feel the wave of relaxation (10 seconds)`;
    }, 5000);
    
    setTimeout(() => {
      btn.classList.remove('active');
      currentMuscleIndex++;
      runMuscle();
    }, 15000);
  }
  
  runMuscle();
});

$('stopPMR').addEventListener('click', () => {
  state.pmrRunning = false;
  $('startPMR').disabled = false;
  document.querySelectorAll('.muscle-btn').forEach(b => b.classList.remove('active'));
  $('pmrInstruction').textContent = 'Stopped. You can restart or click individual muscle groups.';
  clearTimeout(pmrTimer);
});

/* ===== GRATITUDE PRACTICE ===== */
$('addGratitude').addEventListener('click', () => {
  const text = $('gratitudeInput').value.trim();
  if (!text) return;
  
  const item = document.createElement('div');
  item.className = 'gratitude-item';
  item.innerHTML = `
    <span>${text}</span>
    <button onclick="this.parentElement.remove()">×</button>
  `;
  $('gratitudeList').prepend(item);
  $('gratitudeInput').value = '';
  
  const startAnger = state.currentAngerLevel;
  
  addEntry({
    type: 'gratitude',
    technique: 'Gratitude Practice',
    startAnger,
    gratitude: text,
    notes: `Added gratitude: ${text}`
  });
  
  markTechniqueUsed('gratitude');
  
  // Keep only last 10 in view
  while ($('gratitudeList').children.length > 10) {
    $('gratitudeList').removeChild($('gratitudeList').lastChild);
  }
});

$('gratitudeInput').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') $('addGratitude').click();
});

/* ===== ANGER THERMOMETER ===== */
$('angerLevel').addEventListener('input', (e) => {
  const level = parseInt(e.target.value);
  state.currentAngerLevel = level;
  
  // Calculate position: 0 = bottom (0px), 10 = top (240px)
  const pixelPosition = (level / 10) * 240;
  $('thermMarker').style.bottom = pixelPosition + 'px';
  
  let pill = $('angerPill');
  pill.textContent = `Level: ${level}`;
  pill.className = 'pill';
  if (level >= 7) pill.className = 'pill danger';
  else if (level >= 4) pill.className = 'pill warning';
});

$('logAnger').addEventListener('click', () => {
  const level = state.currentAngerLevel;
  const notes = $('angerNotes').value.trim();
  
  addEntry({
    type: 'log',
    technique: 'Anger Level Log',
    startAnger: level,
    endAnger: level,
    notes: notes || 'Logged current anger level'
  });
  
  $('angerNotes').value = '';
  
  updateAngerHistory();
  alert('Anger level logged successfully!');
});

function updateAngerHistory() {
  const recent = state.entries
    .filter(e => e.type === 'log' || e.startAnger !== undefined)
    .slice(0, 3);
  
  const html = recent.map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    return `<div style="font-size:11px;margin:4px 0">• ${time}: Level ${e.startAnger}/10</div>`;
  }).join('');
  
  $('angerHistory').innerHTML = html || '<div class="tiny">No readings yet</div>';
}

/* ===== ENTRY MANAGEMENT ===== */
function addEntry(entry) {
  const fullEntry = {
    ...entry,
    timestamp: new Date().toISOString(),
    id: Date.now() + Math.random()
  };
  
  state.entries.unshift(fullEntry);
  localStorage.setItem('angerEntries', JSON.stringify(state.entries));
  
  updateAngerHistory();
}

/* ===== PROGRESS TRACKING ===== */
function markTechniqueUsed(technique) {
  const today = new Date().toDateString();
  
  if (!state.techniquesUsed[today]) {
    state.techniquesUsed[today] = [];
  }
  
  if (!state.techniquesUsed[today].includes(technique)) {
    state.techniquesUsed[today].push(technique);
    localStorage.setItem('techniquesUsed', JSON.stringify(state.techniquesUsed));
  }
  
  updateProgress();
}

function updateProgress() {
  const today = new Date().toDateString();
  const todayTechs = state.techniquesUsed[today] || [];
  
  const count = todayTechs.length;
  $('techniqueCount').textContent = `${count}/4`;
  
  const circumference = 326.73;
  const offset = circumference - (count / 4) * circumference;
  $('progressCircle').style.strokeDashoffset = offset;
  
  ['breath', 'reappraisal', 'pmr', 'gratitude'].forEach(tech => {
    const pill = $(`${tech}Pill`);
    if (todayTechs.includes(tech)) {
      pill.style.opacity = '1';
    } else {
      pill.style.opacity = '0.3';
    }
  });
}

/* ===== DASHBOARD ===== */
$('dashboardBtn').addEventListener('click', () => {
  $('mainView').classList.add('hidden');
  $('dashboardView').classList.add('active');
  renderDashboard();
});

$('backBtn').addEventListener('click', () => {
  $('mainView').classList.remove('hidden');
  $('dashboardView').classList.remove('active');
});

// Tab switching
document.querySelectorAll('.tab-btn').forEach(btn => {
  btn.addEventListener('click', (e) => {
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    e.target.classList.add('active');
    
    const tab = e.target.dataset.tab;
    document.querySelectorAll('.tab-content').forEach(t => t.style.display = 'none');
    $(`${tab}Tab`).style.display = 'block';
    
    if (tab === 'stats') renderStats();
  });
});

function renderDashboard() {
  const today = new Date().toDateString();
  const todayEntries = state.entries.filter(e => new Date(e.timestamp).toDateString() === today);
  
  // Overview stats
  const avgAnger = todayEntries.length > 0 
    ? (todayEntries.reduce((sum, e) => sum + (e.startAnger || 0), 0) / todayEntries.length).toFixed(1)
    : 0;
  
  $('avgAngerToday').textContent = avgAnger;
  $('entriesCountToday').textContent = todayEntries.length;
  $('sighsToday').textContent = localStorage.getItem('sighCount') || 0;
  
  // Recent entries
  renderRecentEntries();
  renderHistoryLog();
}

function renderRecentEntries() {
  const recent = state.entries.slice(0, 5);
  const html = recent.map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const date = new Date(e.timestamp).toLocaleDateString();
    
    let content = `<div class="history-entry">
      <h4>${e.technique}</h4>
      <div class="meta">${date} at ${time}</div>`;
    
    if (e.startAnger !== undefined) {
      content += `<div class="tiny">Anger: ${e.startAnger}/10`;
      if (e.endAnger !== undefined && e.endAnger !== e.startAnger) {
        content += ` → ${e.endAnger}/10 <strong style="color:var(--accent)">(↓${e.reduction})</strong>`;
      }
      content += `</div>`;
    }
    
    if (e.notes) {
      content += `<div class="notes">${e.notes}</div>`;
    }
    
    if (e.trigger) {
      content += `<div class="notes"><strong>Trigger:</strong> ${e.trigger}</div>`;
    }
    
    if (e.reframe) {
      content += `<div class="notes"><strong>Reframe:</strong> ${e.reframe.substring(0, 150)}...</div>`;
    }
    
    content += `</div>`;
    return content;
  }).join('');
  
  $('recentEntries').innerHTML = html || '<p class="tiny">No entries yet today</p>';
}

function renderHistoryLog(filterDate = null) {
  let entries = state.entries;
  
  if (filterDate) {
    entries = entries.filter(e => {
      const entryDate = new Date(e.timestamp).toDateString();
      const filter = new Date(filterDate).toDateString();
      return entryDate === filter;
    });
  }
  
  const html = entries.map(e => {
    const time = new Date(e.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    const date = new Date(e.timestamp).toLocaleDateString();
    
    let content = `<div class="history-entry">
      <h4>${e.technique}</h4>
      <div class="meta">${date} at ${time}</div>`;
    
    if (e.startAnger !== undefined) {
      content += `<div class="tiny" style="margin-top:8px"><strong>Anger Level:</strong> ${e.startAnger}/10`;
      if (e.endAnger !== undefined && e.endAnger !== e.startAnger) {
        content += ` → ${e.endAnger}/10 <span style="color:var(--accent);font-weight:600">(Reduced by ${e.reduction})</span>`;
      }
      content += `</div>`;
    }
    
    if (e.trigger) {
      content += `<div class="notes"><strong>What triggered it:</strong><br>${e.trigger}</div>`;
    }
    
    if (e.reframe) {
      content += `<div class="notes"><strong>How you reframed it:</strong><br>${e.reframe}</div>`;
    }
    
    if (e.gratitude) {
      content += `<div class="notes"><strong>Gratitude:</strong> ${e.gratitude}</div>`;
    }
    
    if (e.notes && !e.trigger && !e.reframe) {
      content += `<div class="notes">${e.notes}</div>`;
    }
    
    content += `</div>`;
    return content;
  }).join('');
  
  $('historyLog').innerHTML = html || '<p class="tiny">No entries found</p>';
}

$('filterDate').addEventListener('change', (e) => {
  renderHistoryLog(e.target.value);
});

$('clearFilter').addEventListener('click', () => {
  $('filterDate').value = '';
  renderHistoryLog();
});

function renderStats() {
  // Calculate effectiveness of each technique
  const techniques = {
    breathing: [],
    reappraisal: [],
    pmr: [],
    gratitude: []
  };
  
  state.entries.forEach(e => {
    if (e.reduction !== undefined && e.reduction > 0) {
      if (e.type === 'breathing') techniques.breathing.push(e.reduction);
      if (e.type === 'reappraisal') techniques.reappraisal.push(e.reduction);
      if (e.type === 'pmr') techniques.pmr.push(e.reduction);
      if (e.type === 'gratitude') techniques.gratitude.push(e.reduction);
    }
  });
  
  const avgReduction = (arr) => arr.length > 0 ? arr.reduce((a,b) => a+b, 0) / arr.length : 0;
  
  $('breathEffect').style.width = (avgReduction(techniques.breathing) * 10) + '%';
  $('breathEffect').textContent = avgReduction(techniques.breathing).toFixed(1);
  
  $('reappraisalEffect').style.width = (avgReduction(techniques.reappraisal) * 10) + '%';
  $('reappraisalEffect').textContent = avgReduction(techniques.reappraisal).toFixed(1);
  
  $('pmrEffect').style.width = (avgReduction(techniques.pmr) * 10) + '%';
  $('pmrEffect').textContent = avgReduction(techniques.pmr).toFixed(1);
  
  $('gratitudeEffect').style.width = (avgReduction(techniques.gratitude) * 10) + '%';
  $('gratitudeEffect').textContent = avgReduction(techniques.gratitude).toFixed(1);
  
  // 7-day trend
  const last7Days = [];
  for (let i = 6; i >= 0; i--) {
    const date = new Date();
    date.setDate(date.getDate() - i);
    last7Days.push(date.toDateString());
  }
  
  const trendData = last7Days.map(date => {
    const dayEntries = state.entries.filter(e => new Date(e.timestamp).toDateString() === date);
    const avgAnger = dayEntries.length > 0
      ? (dayEntries.reduce((sum, e) => sum + (e.startAnger || 0), 0) / dayEntries.length).toFixed(1)
      : 0;
    return { date: new Date(date).toLocaleDateString([], {weekday: 'short'}), anger: avgAnger };
  });
  
  const trendHtml = trendData.map(d => `
    <div style="margin:8px 0">
      <div class="tiny" style="margin-bottom:4px">${d.date}</div>
      <div class="chart-bar">
        <div class="chart-fill" style="width:${d.anger * 10}%"></div>
      </div>
      <div class="tiny" style="color:var(--muted)">${d.anger}/10</div>
    </div>
  `).join('');
  
  $('weeklyTrend').innerHTML = trendHtml;
}

/* ===== INITIALIZATION ===== */
(function init() {
  // Load initial data
  $('sighCount').textContent = localStorage.getItem('sighCount') || 0;
  updateProgress();
  updateAngerHistory();
  
  // Set initial thermometer
  $('angerLevel').dispatchEvent(new Event('input'));
  
  // Auto-suggest breathing if anger is high
  $('angerLevel').addEventListener('change', (e) => {
    const level = parseInt(e.target.value);
    if (level >= 7 && !state.sighRunning) {
      setTimeout(() => {
        if (confirm('High anger detected (7+). Start Physiological Sigh breathing immediately? This is the fastest way to calm down.')) {
          startSigh();
        }
      }, 500);
    }
  });
  
  // Keyboard shortcuts
  document.addEventListener('keydown', (e) => {
    if (e.target.matches('input, textarea')) return;
    
    if (e.key === 'b') {
      e.preventDefault();
      $('startSigh').click();
    }
    if (e.key === 'd') {
      e.preventDefault();
      $('dashboardBtn').click();
    }
  });
})();
</script>
</body>
</html>
